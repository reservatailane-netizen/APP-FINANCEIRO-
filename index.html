<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FinanceApp</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #13131a;
  --bg3: #1c1c28;
  --card: #1a1a24;
  --border: #2a2a3a;
  --text: #f0f0ff;
  --text2: #8888aa;
  --green: #00e5a0;
  --red: #ff4d6d;
  --yellow: #ffd166;
  --blue: #4d9fff;
  --purple: #a855f7;
  --accent: #00e5a0;
  --radius: 16px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
[data-theme="light"] {
  --bg: #f4f4f8;
  --bg2: #ffffff;
  --bg3: #eaeaf2;
  --card: #ffffff;
  --border: #e0e0ee;
  --text: #0a0a1a;
  --text2: #5555777;
  --shadow: 0 4px 24px rgba(0,0,0,0.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
  overflow-x: hidden;
}
h1,h2,h3 { font-family: 'Syne', sans-serif; }

/* HEADER */
.header {
  background: var(--bg2);
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left { display: flex; flex-direction: column; gap: 1px; }
.header h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
.header h1 span { color: var(--green); }
.user-name { font-size: 12px; font-weight: 400; color: var(--text2); font-family: 'DM Sans', sans-serif; }
.settings-btn {
  background: var(--bg3);
  border: none;
  border-radius: 50%;
  width: 40px; height: 40px;
  font-size: 20px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s;
}
.settings-btn:active { transform: scale(0.9); }

/* SETTINGS PANEL */
.settings-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 300;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
  backdrop-filter: blur(4px);
}
.settings-overlay.open { opacity: 1; pointer-events: all; }
.settings-panel {
  position: fixed;
  bottom: 0; left: 50%;
  transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: 480px;
  background: var(--bg2);
  border-radius: 24px 24px 0 0;
  z-index: 400;
  padding: 0 0 40px;
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
  max-height: 88vh;
  overflow-y: auto;
}
.settings-panel.open { transform: translateX(-50%) translateY(0); }
.settings-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 20px 12px;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; background: var(--bg2); z-index: 1;
}
.settings-close {
  background: var(--bg3); border: none; border-radius: 50%;
  width: 32px; height: 32px; font-size: 14px; cursor: pointer;
  color: var(--text2); display: flex; align-items: center; justify-content: center;
}
.settings-section-title {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text2);
  padding: 16px 20px 6px;
}
.settings-item {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 20px;
  cursor: pointer;
  transition: background 0.15s;
  border-bottom: 1px solid var(--border);
}
.settings-item:last-child { border-bottom: none; }
.settings-item:active { background: var(--bg3); }
.settings-item-icon { font-size: 22px; width: 36px; text-align: center; }
.settings-item-info { flex: 1; }
.settings-item-label { font-size: 15px; font-weight: 500; }
.settings-item-sub { font-size: 12px; color: var(--text2); margin-top: 1px; }
.settings-arrow { font-size: 20px; color: var(--text2); }
.settings-toggle {
  width: 44px; height: 26px; border-radius: 99px;
  background: var(--bg3); border: 1.5px solid var(--border);
  padding: 3px; display: flex; align-items: center;
  transition: background 0.3s;
}
.settings-toggle div {
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--text2); transition: all 0.3s;
}
.settings-toggle.on { background: rgba(0,229,160,0.2); border-color: var(--green); }
.settings-toggle.on div { background: var(--green); transform: translateX(18px); }

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 500;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal-box {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 24px 20px;
  width: 100%; max-width: 360px;
  animation: fadeIn 0.2s ease;
}

/* PAGES */
.page { display: none; padding: 20px 16px 100px; animation: fadeIn 0.3s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* BOTTOM NAV */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 50%;
  transform: translateX(-50%);
  width: 100%; max-width: 480px;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 0;
  cursor: pointer;
  gap: 4px;
  transition: all 0.2s;
  border: none;
  background: none;
  color: var(--text2);
  font-family: 'DM Sans', sans-serif;
  font-size: 11px;
}
.nav-item.active { color: var(--green); }
.nav-item .icon { font-size: 22px; }
.nav-item.active .icon { transform: scale(1.15); }

/* CARDS */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: 14px;
}
.card-sm { padding: 14px 16px; }

/* DASHBOARD */
.balance-card {
  background: linear-gradient(135deg, #00e5a0 0%, #00b37e 100%);
  border-radius: 20px;
  padding: 24px 20px;
  margin-bottom: 14px;
  color: #003322;
  position: relative;
  overflow: hidden;
}
.balance-card::after {
  content: '';
  position: absolute;
  width: 200px; height: 200px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  top: -80px; right: -60px;
}
.balance-label { font-size: 13px; font-weight: 500; opacity: 0.8; margin-bottom: 4px; }
.balance-value { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; letter-spacing: -1px; }
.balance-month { font-size: 12px; opacity: 0.7; margin-top: 6px; }

.income-expense-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.ie-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
}
.ie-label { font-size: 12px; color: var(--text2); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
.ie-value { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; }
.ie-value.green { color: var(--green); }
.ie-value.red { color: var(--red); }

.section-title {
  font-family: 'Syne', sans-serif;
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.alert-card {
  background: rgba(255, 209, 102, 0.08);
  border: 1px solid rgba(255, 209, 102, 0.3);
  border-radius: var(--radius);
  padding: 12px 14px;
  font-size: 13px;
  color: var(--yellow);
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
  animation: slideIn 0.3s ease;
}
@keyframes slideIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }

/* CHARTS */
.chart-wrapper {
  position: relative;
  height: 200px;
  margin-top: 8px;
}
.chart-wrapper-lg { height: 240px; }

/* FORM */
.form-group { margin-bottom: 14px; }
.form-label { font-size: 13px; color: var(--text2); margin-bottom: 6px; display: block; font-weight: 500; }
.form-input, .form-select {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 13px 16px;
  font-size: 15px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
.form-input:focus, .form-select:focus { border-color: var(--green); }
.form-select option { background: var(--bg2); }

.type-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
.type-btn {
  padding: 12px;
  border-radius: 12px;
  border: 1.5px solid var(--border);
  background: var(--bg3);
  color: var(--text2);
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'DM Sans', sans-serif;
}
.type-btn.active-entrada { background: rgba(0,229,160,0.12); border-color: var(--green); color: var(--green); }
.type-btn.active-saida { background: rgba(255,77,109,0.12); border-color: var(--red); color: var(--red); }

.btn-primary {
  width: 100%;
  padding: 16px;
  background: var(--green);
  color: #003322;
  border: none;
  border-radius: 14px;
  font-size: 16px;
  font-weight: 700;
  font-family: 'Syne', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.2px;
}
.btn-primary:active { transform: scale(0.97); opacity: 0.9; }

/* TRANSACTION LIST */
.tx-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
  animation: fadeIn 0.3s ease;
}
.tx-item:last-child { border-bottom: none; }
.tx-icon {
  width: 44px; height: 44px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.tx-icon.entrada { background: rgba(0,229,160,0.12); }
.tx-icon.saida { background: rgba(255,77,109,0.12); }
.tx-info { flex: 1; min-width: 0; }
.tx-desc { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tx-meta { font-size: 12px; color: var(--text2); margin-top: 2px; }
.tx-amount { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
.tx-amount.green { color: var(--green); }
.tx-amount.red { color: var(--red); }
.tx-delete { background: none; border: none; color: var(--text2); font-size: 18px; padding: 6px; cursor: pointer; transition: color 0.2s; }
.tx-delete:active { color: var(--red); }

/* FILTERS */
.filter-row { display: flex; gap: 8px; margin-bottom: 14px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
.filter-row::-webkit-scrollbar { display: none; }
.filter-chip {
  padding: 7px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg3);
  color: var(--text2);
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'DM Sans', sans-serif;
}
.filter-chip.active { background: var(--green); color: #003322; border-color: var(--green); font-weight: 600; }

/* PROGRESS BAR */
.progress-wrap { margin-bottom: 14px; }
.progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 13px; }
.progress-track { background: var(--bg3); border-radius: 99px; height: 10px; overflow: hidden; }
.progress-bar { height: 100%; border-radius: 99px; transition: width 0.5s ease; }
.progress-bar.green { background: var(--green); }
.progress-bar.yellow { background: var(--yellow); }
.progress-bar.red { background: var(--red); }

/* METAS FORM */
.meta-input-row { display: flex; gap: 8px; align-items: flex-end; }
.meta-input-row .form-input { flex: 1; }
.btn-sm {
  padding: 13px 16px;
  background: var(--green);
  color: #003322;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  white-space: nowrap;
  transition: all 0.2s;
}
.btn-sm:active { transform: scale(0.95); }

/* RANKING */
.rank-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.rank-item:last-child { border-bottom: none; }
.rank-num { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; color: var(--text2); width: 24px; }
.rank-info { flex: 1; }
.rank-cat { font-size: 14px; font-weight: 500; }
.rank-val { font-size: 12px; color: var(--text2); margin-top: 1px; }
.rank-amount { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; color: var(--red); }

/* MONTH SELECTOR */
.month-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.month-selector select { flex: 1; }
.month-arrow { background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: all 0.2s; }
.month-arrow:active { background: var(--green); color: #003322; }

/* TOAST */
.toast {
  position: fixed;
  bottom: 80px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 500;
  z-index: 999;
  opacity: 0;
  transition: all 0.3s;
  white-space: nowrap;
  box-shadow: var(--shadow);
  max-width: 90%;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* EMPTY STATE */
.empty-state { text-align: center; padding: 40px 20px; color: var(--text2); }
.empty-state .icon { font-size: 48px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; }

/* BADGE */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
}
.badge.fixo { background: rgba(77,159,255,0.15); color: var(--blue); }
.badge.variavel { background: rgba(168,85,247,0.15); color: var(--purple); }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>Finance<span>App</span></h1>
    <span class="user-name">Tailane S.</span>
  </div>
  <button class="settings-btn" onclick="openSettings()" title="Configura√ß√µes">‚öôÔ∏è</button>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settings-overlay" onclick="closeSettings()"></div>
<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <span style="font-family:'Syne',sans-serif;font-weight:700;font-size:17px">Configura√ß√µes</span>
    <button class="settings-close" onclick="closeSettings()">‚úï</button>
  </div>

  <div class="settings-section-title">Apar√™ncia</div>
  <div class="settings-item" onclick="toggleTheme()">
    <div class="settings-item-icon">üåô</div>
    <div class="settings-item-info">
      <div class="settings-item-label" id="theme-label">Modo Escuro</div>
      <div class="settings-item-sub">Alternar entre claro e escuro</div>
    </div>
    <div class="settings-toggle" id="theme-toggle-dot"><div></div></div>
  </div>

  <div class="settings-section-title">Exportar & Compartilhar</div>
  <div class="settings-item" onclick="downloadCSV()">
    <div class="settings-item-icon">üì•</div>
    <div class="settings-item-info">
      <div class="settings-item-label">Exportar CSV</div>
      <div class="settings-item-sub">Baixar todos os lan√ßamentos</div>
    </div>
    <span class="settings-arrow">‚Ä∫</span>
  </div>
  <div class="settings-item" onclick="downloadPDF()">
    <div class="settings-item-icon">üìÑ</div>
    <div class="settings-item-info">
      <div class="settings-item-label">Baixar Relat√≥rio PDF</div>
      <div class="settings-item-sub">Resumo financeiro do m√™s atual</div>
    </div>
    <span class="settings-arrow">‚Ä∫</span>
  </div>
  <div class="settings-item" onclick="openEmailModal()">
    <div class="settings-item-icon">üìß</div>
    <div class="settings-item-info">
      <div class="settings-item-label">Enviar por E-mail</div>
      <div class="settings-item-sub">Relat√≥rio no seu e-mail</div>
    </div>
    <span class="settings-arrow">‚Ä∫</span>
  </div>
  <div class="settings-item" onclick="shareWhatsApp()">
    <div class="settings-item-icon">üí¨</div>
    <div class="settings-item-info">
      <div class="settings-item-label">Compartilhar via WhatsApp</div>
      <div class="settings-item-sub">Enviar resumo do m√™s</div>
    </div>
    <span class="settings-arrow">‚Ä∫</span>
  </div>

  <div class="settings-section-title">Dados</div>
  <div class="settings-item" onclick="importJSON()">
    <div class="settings-item-icon">üìÇ</div>
    <div class="settings-item-info">
      <div class="settings-item-label">Importar Dados</div>
      <div class="settings-item-sub">Restaurar backup JSON</div>
    </div>
    <span class="settings-arrow">‚Ä∫</span>
  </div>
  <div class="settings-item" onclick="exportJSON()">
    <div class="settings-item-icon">üíæ</div>
    <div class="settings-item-info">
      <div class="settings-item-label">Backup JSON</div>
      <div class="settings-item-sub">Salvar c√≥pia de seguran√ßa</div>
    </div>
    <span class="settings-arrow">‚Ä∫</span>
  </div>
  <div class="settings-item danger" onclick="confirmClearData()">
    <div class="settings-item-icon">üóëÔ∏è</div>
    <div class="settings-item-info">
      <div class="settings-item-label" style="color:var(--red)">Apagar Todos os Dados</div>
      <div class="settings-item-sub">Essa a√ß√£o n√£o pode ser desfeita</div>
    </div>
    <span class="settings-arrow" style="color:var(--red)">‚Ä∫</span>
  </div>

  <div class="settings-section-title">Sobre</div>
  <div class="settings-item" style="cursor:default">
    <div class="settings-item-icon">üíö</div>
    <div class="settings-item-info">
      <div class="settings-item-label">FinanceApp</div>
      <div class="settings-item-sub">Vers√£o 1.0 ¬∑ Tailane S.</div>
    </div>
  </div>
</div>

<!-- EMAIL MODAL -->
<div class="modal-overlay" id="email-modal" onclick="closeEmailModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:14px">üìß Enviar Relat√≥rio</div>
    <div class="form-group">
      <label class="form-label">Seu e-mail</label>
      <input type="email" class="form-input" id="email-input" placeholder="seuemail@gmail.com">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px">
      <button class="btn-primary" style="background:var(--bg3);color:var(--text);font-size:14px;padding:13px" onclick="closeEmailModal()">Cancelar</button>
      <button class="btn-primary" style="font-size:14px;padding:13px" onclick="sendEmail()">Enviar</button>
    </div>
  </div>
</div>

<!-- IMPORT INPUT -->
<input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(event)">

<div id="page-dashboard" class="page active">
  <div class="balance-card">
    <div class="balance-label">üí∞ Saldo do M√™s</div>
    <div class="balance-value" id="balance-value">R$ 0,00</div>
    <div class="balance-month" id="balance-month"></div>
  </div>
  <div class="income-expense-row">
    <div class="ie-card">
      <div class="ie-label"><span>üü¢</span> Entradas</div>
      <div class="ie-value green" id="total-income">R$ 0,00</div>
    </div>
    <div class="ie-card">
      <div class="ie-label"><span>üî¥</span> Sa√≠das</div>
      <div class="ie-value red" id="total-expense">R$ 0,00</div>
    </div>
  </div>
  <div id="alerts-container"></div>
  <div class="card">
    <div class="section-title">Gastos por Categoria</div>
    <div class="chart-wrapper"><canvas id="pie-chart"></canvas></div>
  </div>
  <div class="card">
    <div class="section-title">Entradas x Sa√≠das (6 meses)</div>
    <div class="chart-wrapper-lg chart-wrapper"><canvas id="bar-chart"></canvas></div>
  </div>
  <div class="card">
    <div class="section-title">Meios de Pagamento (Sa√≠das)</div>
    <div class="chart-wrapper"><canvas id="payment-chart"></canvas></div>
  </div>
</div>

<div id="page-lancamentos" class="page">
  <div class="card">
    <div class="section-title" style="margin-bottom:16px">Novo Lan√ßamento</div>
    <div class="type-toggle">
      <button class="type-btn active-entrada" id="btn-entrada" onclick="setType('entrada')">‚¨ÜÔ∏è Entrada</button>
      <button class="type-btn" id="btn-saida" onclick="setType('saida')">‚¨áÔ∏è Sa√≠da</button>
    </div>
    <div class="form-group">
      <label class="form-label">Data</label>
      <input type="date" class="form-input" id="tx-date">
    </div>
    <div class="form-group">
      <label class="form-label">Valor (R$)</label>
      <input type="number" class="form-input" id="tx-value" placeholder="0,00" min="0" step="0.01">
    </div>
    <div class="form-group">
      <label class="form-label">Categoria</label>
      <select class="form-select" id="tx-category"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Descri√ß√£o</label>
      <input type="text" class="form-input" id="tx-desc" placeholder="Ex: Supermercado, Sal√°rio...">
    </div>
    <div class="form-group">
      <label class="form-label">Forma de Pagamento</label>
      <select class="form-select" id="tx-payment" onchange="onPaymentChange()">
        <option value="pix">üí∏ Pix</option>
        <option value="debito">üí≥ D√©bito</option>
        <option value="credito">üí≥ Cr√©dito</option>
        <option value="dinheiro">üíµ Dinheiro</option>
      </select>
    </div>
    <div class="form-group" id="parcelas-group" style="display:none">
      <label class="form-label">üí≥ N√∫mero de Parcelas</label>
      <select class="form-select" id="tx-parcelas">
        <option value="1">1x (√† vista)</option>
        <option value="2">2x</option>
        <option value="3">3x</option>
        <option value="4">4x</option>
        <option value="5">5x</option>
        <option value="6">6x</option>
        <option value="7">7x</option>
        <option value="8">8x</option>
        <option value="9">9x</option>
        <option value="10">10x</option>
        <option value="11">11x</option>
        <option value="12">12x</option>
        <option value="18">18x</option>
        <option value="24">24x</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Tipo de Gasto</label>
      <select class="form-select" id="tx-kind">
        <option value="variavel">Vari√°vel</option>
        <option value="fixo">Fixo</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Observa√ß√µes (opcional)</label>
      <input type="text" class="form-input" id="tx-obs" placeholder="Alguma nota adicional...">
    </div>
    <button class="btn-primary" onclick="addTransaction()">Adicionar Lan√ßamento</button>
  </div>

  <div class="section-title" style="margin-top:8px">Hist√≥rico</div>
  <div class="filter-row" id="month-filters"></div>
  <div class="filter-row" id="type-filters">
    <div class="filter-chip active" onclick="setFilter('type','todos',this)">Todos</div>
    <div class="filter-chip" onclick="setFilter('type','entrada',this)">Entradas</div>
    <div class="filter-chip" onclick="setFilter('type','saida',this)">Sa√≠das</div>
  </div>
  <div class="filter-row" id="payment-filters">
    <div class="filter-chip active" onclick="setFilter('payment','todos',this)">üí≥ Todos</div>
    <div class="filter-chip" onclick="setFilter('payment','pix',this)">üí∏ Pix</div>
    <div class="filter-chip" onclick="setFilter('payment','debito',this)">üí≥ D√©bito</div>
    <div class="filter-chip" onclick="setFilter('payment','credito',this)">üí≥ Cr√©dito</div>
    <div class="filter-chip" onclick="setFilter('payment','dinheiro',this)">üíµ Dinheiro</div>
  </div>
  <div class="filter-row" id="group-filters" style="display:none"></div>
  <div class="card" id="tx-list-container">
    <div id="tx-list"></div>
  </div>
</div>

<div id="page-metas" class="page">
  <div class="card">
    <div class="section-title" style="margin-bottom:14px">Meta de Economia Mensal</div>
    <div class="form-group">
      <label class="form-label">Quanto quer guardar este m√™s? (R$)</label>
      <div class="meta-input-row">
        <input type="number" class="form-input" id="savings-goal-input" placeholder="Ex: 500">
        <button class="btn-sm" onclick="setSavingsGoal()">Salvar</button>
      </div>
    </div>
    <div id="savings-progress"></div>
  </div>

  <div class="card">
    <div class="section-title" style="margin-bottom:14px">Limite por Categoria</div>
    <div class="form-group">
      <select class="form-select" id="cat-limit-select"></select>
    </div>
    <div class="meta-input-row" style="margin-bottom:14px">
      <input type="number" class="form-input" id="cat-limit-input" placeholder="Limite em R$">
      <button class="btn-sm" onclick="setCategoryLimit()">Definir</button>
    </div>
    <div id="category-limits"></div>
  </div>
</div>

<div id="page-relatorios" class="page">
  <div class="card">
    <div class="section-title" style="margin-bottom:12px">Filtrar Per√≠odo</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div>
        <label class="form-label">De</label>
        <input type="month" class="form-input" id="report-from">
      </div>
      <div>
        <label class="form-label">At√©</label>
        <input type="month" class="form-input" id="report-to">
      </div>
    </div>
    <button class="btn-primary" style="margin-top:12px" onclick="generateReport()">Gerar Relat√≥rio</button>
  </div>

  <div class="card">
    <div class="section-title">Evolu√ß√£o do Saldo</div>
    <div class="chart-wrapper-lg chart-wrapper"><canvas id="line-chart"></canvas></div>
  </div>

  <div class="card">
    <div class="section-title">Comparativo Mensal</div>
    <div class="chart-wrapper-lg chart-wrapper"><canvas id="compare-chart"></canvas></div>
  </div>

  <div class="card">
    <div class="section-title">üèÜ Ranking de Gastos</div>
    <div id="ranking-list"></div>
  </div>

  <div class="card">
    <div class="section-title">M√©dia por Categoria</div>
    <div id="avg-list"></div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-item active" onclick="navigate('dashboard',this)">
    <span class="icon">üìä</span><span>Dashboard</span>
  </button>
  <button class="nav-item" onclick="navigate('lancamentos',this)">
    <span class="icon">‚ûï</span><span>Lan√ßamentos</span>
  </button>
  <button class="nav-item" onclick="navigate('metas',this)">
    <span class="icon">üéØ</span><span>Metas</span>
  </button>
  <button class="nav-item" onclick="navigate('relatorios',this)">
    <span class="icon">üìà</span><span>Relat√≥rios</span>
  </button>
</nav>

<div class="toast" id="toast"></div>

<script>
const CATEGORIES = {
  saida: ['Moradia','Alimenta√ß√£o','Transporte','Sa√∫de','Lazer','Assinaturas','Roupas','Educa√ß√£o','Imprevistos','Outros'],
  entrada: ['Sal√°rio','Freelance','Investimentos','Outros']
};
const CAT_ICONS = {
  'Moradia':'üè†','Alimenta√ß√£o':'üçî','Transporte':'üöó','Sa√∫de':'üíä','Lazer':'üéÆ','Assinaturas':'üì±','Roupas':'üëï','Educa√ß√£o':'üìö','Imprevistos':'‚ö†Ô∏è','Outros':'üíº','Sal√°rio':'üí∞','Freelance':'üíª','Investimentos':'üìà'
};

let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
let goals = JSON.parse(localStorage.getItem('goals') || '{}');
let catLimits = JSON.parse(localStorage.getItem('catLimits') || '{}');
let currentType = 'entrada';
let filterType = 'todos';
let filterMonth = '';
let filterPayment = 'todos';
let filterGroupId = null;
let charts = {};

const now = new Date();
let currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

function fmt(v) {
  return 'R$ ' + Math.abs(v).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast show ${type}`;
  setTimeout(() => t.className = 'toast', 2500);
}
function navigate(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if(el) el.classList.add('active');
  if(page==='dashboard') updateDashboard();
  if(page==='lancamentos') { buildMonthFilters(); renderTxList(); }
  if(page==='metas') renderMetas();
  if(page==='relatorios') renderRelatorios();
}
function openSettings() {
  document.getElementById('settings-overlay').classList.add('open');
  document.getElementById('settings-panel').classList.add('open');
  updateThemeToggle();
}
function closeSettings() {
  document.getElementById('settings-overlay').classList.remove('open');
  document.getElementById('settings-panel').classList.remove('open');
}
function updateThemeToggle() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  const tog = document.getElementById('theme-toggle-dot');
  const lbl = document.getElementById('theme-label');
  tog.className = 'settings-toggle' + (isDark ? ' on' : '');
  lbl.textContent = isDark ? 'Modo Escuro (ativo)' : 'Modo Claro (ativo)';
}
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  updateThemeToggle();
  setTimeout(() => { updateDashboard(); renderRelatorios(); }, 100);
}

// CSV EXPORT
function downloadCSV() {
  closeSettings();
  if(!transactions.length) { showToast('‚ö†Ô∏è Nenhum dado para exportar', 'error'); return; }
  const headers = ['Data','Tipo','Valor','Categoria','Descri√ß√£o','Pagamento','Fixo/Vari√°vel','Observa√ß√µes'];
  const rows = transactions.map(t => [t.date, t.type, t.value.toFixed(2), t.category, t.desc, t.payment, t.kind, t.obs||'']);
  const csv = [headers, ...rows].map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `financeapp_${currentMonth}.csv`; a.click();
  URL.revokeObjectURL(url);
  showToast('‚úÖ CSV baixado!');
}

// PDF EXPORT
function downloadPDF() {
  closeSettings();
  const txs = getMonthTx(currentMonth);
  const income = txs.filter(t=>t.type==='entrada').reduce((s,t)=>s+t.value,0);
  const expense = txs.filter(t=>t.type==='saida').reduce((s,t)=>s+t.value,0);
  const balance = income - expense;
  const [y,m] = currentMonth.split('-');
  const monthLabel = new Date(y,m-1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const catTotals = {};
  txs.filter(t=>t.type==='saida').forEach(t => { catTotals[t.category]=(catTotals[t.category]||0)+t.value; });
  const catRows = Object.entries(catTotals).sort((a,b)=>b[1]-a[1])
    .map(([cat,val]) => `<tr><td>${CAT_ICONS[cat]||''} ${cat}</td><td style="color:#ff4d6d;text-align:right">${fmt(val)}</td></tr>`).join('');
  const txRows = txs.slice(0,30).map(t => `<tr>
    <td>${new Date(t.date+'T12:00').toLocaleDateString('pt-BR')}</td>
    <td>${t.desc}</td>
    <td>${t.category}</td>
    <td style="color:${t.type==='entrada'?'#00b37e':'#cc3355'};text-align:right">${t.type==='entrada'?'+':'-'}${fmt(t.value)}</td>
  </tr>`).join('');
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    body{font-family:Arial,sans-serif;padding:32px;color:#111;max-width:700px;margin:0 auto}
    h1{color:#00b37e;font-size:26px;margin-bottom:4px}
    .sub{color:#888;font-size:14px;margin-bottom:28px}
    .cards{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:28px}
    .card{border:1.5px solid #eee;border-radius:12px;padding:16px;text-align:center}
    .card-label{font-size:12px;color:#888;margin-bottom:4px}
    .card-value{font-size:22px;font-weight:700}
    .green{color:#00b37e}.red{color:#cc3355}
    table{width:100%;border-collapse:collapse;margin-bottom:28px;font-size:13px}
    th{background:#f5f5f5;padding:10px 12px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:#666}
    td{padding:9px 12px;border-bottom:1px solid #f0f0f0}
    tr:last-child td{border-bottom:none}
    h2{font-size:15px;font-weight:700;color:#444;text-transform:uppercase;letter-spacing:0.5px;margin:20px 0 10px}
    .footer{margin-top:32px;font-size:12px;color:#aaa;text-align:center}
  </style></head><body>
  <h1>FinanceApp</h1>
  <div class="sub">Relat√≥rio Financeiro ¬∑ ${monthLabel.charAt(0).toUpperCase()+monthLabel.slice(1)} ¬∑ Tailane S.</div>
  <div class="cards">
    <div class="card"><div class="card-label">Entradas</div><div class="card-value green">${fmt(income)}</div></div>
    <div class="card"><div class="card-label">Sa√≠das</div><div class="card-value red">${fmt(expense)}</div></div>
    <div class="card"><div class="card-label">Saldo</div><div class="card-value ${balance>=0?'green':'red'}">${fmt(balance)}</div></div>
  </div>
  <h2>Gastos por Categoria</h2>
  <table><thead><tr><th>Categoria</th><th style="text-align:right">Total</th></tr></thead><tbody>${catRows||'<tr><td colspan="2" style="text-align:center;color:#aaa">Sem dados</td></tr>'}</tbody></table>
  <h2>Lan√ßamentos (√∫ltimos 30)</h2>
  <table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th style="text-align:right">Valor</th></tr></thead><tbody>${txRows||'<tr><td colspan="4" style="text-align:center;color:#aaa">Sem dados</td></tr>'}</tbody></table>
  <div class="footer">Gerado por FinanceApp ¬∑ ${new Date().toLocaleDateString('pt-BR')}</div>
  </body></html>`;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 500);
  showToast('üìÑ PDF aberto para impress√£o!');
}

// EMAIL
function openEmailModal() {
  closeSettings();
  document.getElementById('email-modal').classList.add('open');
}
function closeEmailModal() {
  document.getElementById('email-modal').classList.remove('open');
}
function sendEmail() {
  const email = document.getElementById('email-input').value.trim();
  if(!email || !email.includes('@')) { showToast('‚ö†Ô∏è E-mail inv√°lido', 'error'); return; }
  const txs = getMonthTx(currentMonth);
  const income = txs.filter(t=>t.type==='entrada').reduce((s,t)=>s+t.value,0);
  const expense = txs.filter(t=>t.type==='saida').reduce((s,t)=>s+t.value,0);
  const balance = income - expense;
  const [y,m] = currentMonth.split('-');
  const monthLabel = new Date(y,m-1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const subject = `Relat√≥rio FinanceApp ‚Äì ${monthLabel}`;
  const body = `Ol√° Tailane!\n\nRelat√≥rio Financeiro de ${monthLabel}:\n\nüíö Entradas: ${fmt(income)}\nüî¥ Sa√≠das: ${fmt(expense)}\nüìä Saldo: ${fmt(balance)}\n\nGerado pelo FinanceApp.`;
  window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  closeEmailModal();
  showToast('üìß Abrindo cliente de e-mail...');
}

// WHATSAPP
function shareWhatsApp() {
  closeSettings();
  const txs = getMonthTx(currentMonth);
  const income = txs.filter(t=>t.type==='entrada').reduce((s,t)=>s+t.value,0);
  const expense = txs.filter(t=>t.type==='saida').reduce((s,t)=>s+t.value,0);
  const balance = income - expense;
  const [y,m] = currentMonth.split('-');
  const monthLabel = new Date(y,m-1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const msg = `üìä *Resumo FinanceApp ‚Äì ${monthLabel}*\n\nüíö Entradas: *${fmt(income)}*\nüî¥ Sa√≠das: *${fmt(expense)}*\nüìà Saldo: *${fmt(balance)}*\n\n_Gerado pelo FinanceApp_`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
}

// BACKUP JSON
function exportJSON() {
  closeSettings();
  const data = { transactions, goals, catLimits, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `financeapp_backup_${currentMonth}.json`; a.click();
  URL.revokeObjectURL(url);
  showToast('üíæ Backup exportado!');
}
function importJSON() {
  closeSettings();
  document.getElementById('import-file').click();
}
function handleImport(e) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if(data.transactions) transactions = data.transactions;
      if(data.goals) goals = data.goals;
      if(data.catLimits) catLimits = data.catLimits;
      save(); updateDashboard(); buildMonthFilters(); renderTxList();
      showToast('‚úÖ Dados importados com sucesso!');
    } catch(err) { showToast('‚ùå Arquivo inv√°lido', 'error'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}
function confirmClearData() {
  closeSettings();
  if(confirm('‚ö†Ô∏è Tem certeza? Todos os dados ser√£o apagados permanentemente!')) {
    transactions = []; goals = {}; catLimits = {};
    save(); updateDashboard(); buildMonthFilters(); renderTxList();
    showToast('üóëÔ∏è Dados apagados', 'error');
  }
}
function setType(type) {
  currentType = type;
  document.getElementById('btn-entrada').className = 'type-btn' + (type==='entrada' ? ' active-entrada' : '');
  document.getElementById('btn-saida').className = 'type-btn' + (type==='saida' ? ' active-saida' : '');
  updateCategoryOptions();
  if(type === 'entrada') {
    document.getElementById('parcelas-group').style.display = 'none';
    document.getElementById('tx-payment').value = 'pix';
  }
}
function onPaymentChange() {
  const payment = document.getElementById('tx-payment').value;
  const pg = document.getElementById('parcelas-group');
  if(payment === 'credito' && currentType === 'saida') {
    pg.style.display = 'block';
  } else {
    pg.style.display = 'none';
    document.getElementById('tx-parcelas').value = '1';
  }
}
function updateCategoryOptions() {
  const sel = document.getElementById('tx-category');
  sel.innerHTML = CATEGORIES[currentType].map(c => `<option value="${c}">${CAT_ICONS[c]||'üíº'} ${c}</option>`).join('');
}
function setFilter(key, val, el) {
  if(key==='type') { filterType = val; document.querySelectorAll('#type-filters .filter-chip').forEach(c => c.classList.remove('active')); }
  if(key==='month') { filterMonth = val; document.querySelectorAll('#month-filters .filter-chip').forEach(c => c.classList.remove('active')); }
  if(key==='payment') { filterPayment = val; document.querySelectorAll('#payment-filters .filter-chip').forEach(c => c.classList.remove('active')); }
  if(key==='group') { filterGroupId = val ? Number(val) : null; document.querySelectorAll('#group-filters .filter-chip').forEach(c => c.classList.remove('active')); }
  el.classList.add('active');
  renderTxList();
}
function clearGroupFilter() {
  filterGroupId = null;
  document.getElementById('group-filters').style.display = 'none';
  renderTxList();
}
function buildGroupFilter(groupId, desc, total) {
  const gf = document.getElementById('group-filters');
  gf.style.display = 'flex';
  gf.innerHTML = `<div class="filter-chip active" onclick="setFilter('group','${groupId}',this)">üîç ${desc} (${total}x)</div><div class="filter-chip" onclick="clearGroupFilter()" style="background:var(--bg3)">‚úï Limpar</div>`;
}
function buildMonthFilters() {
  const months = [...new Set(transactions.map(t => t.date.substring(0,7)))].sort().reverse();
  const container = document.getElementById('month-filters');
  container.innerHTML = `<div class="filter-chip ${filterMonth==='' ? 'active':''}" onclick="setFilter('month','',this)">Todos</div>` +
    months.map(m => {
      const [y,mo] = m.split('-');
      const label = new Date(y, mo-1).toLocaleDateString('pt-BR',{month:'short',year:'2-digit'});
      return `<div class="filter-chip ${filterMonth===m?'active':''}" onclick="setFilter('month','${m}',this)">${label}</div>`;
    }).join('');
}
function addTransaction() {
  const date = document.getElementById('tx-date').value;
  const value = parseFloat(document.getElementById('tx-value').value);
  const category = document.getElementById('tx-category').value;
  const desc = document.getElementById('tx-desc').value;
  const payment = document.getElementById('tx-payment').value;
  const kind = document.getElementById('tx-kind').value;
  const obs = document.getElementById('tx-obs').value;
  const parcelas = payment === 'credito' && currentType === 'saida'
    ? parseInt(document.getElementById('tx-parcelas').value) : 1;
  if(!date || !value || value<=0) { showToast('‚ö†Ô∏è Preencha data e valor!', 'error'); return; }

  if(parcelas > 1) {
    const valorParcela = parseFloat((value / parcelas).toFixed(2));
    const [y, m] = date.split('-');
    const groupId = Date.now();
    for(let i = 0; i < parcelas; i++) {
      const d = new Date(parseInt(y), parseInt(m)-1+i, parseInt(date.split('-')[2]));
      const txDate = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
      const tx = {
        id: groupId + i,
        date: txDate,
        value: valorParcela,
        category, payment, kind, obs,
        desc: (desc||category) + ' (' + (i+1) + '/' + parcelas + ')',
        type: currentType,
        parcelado: true, parcela: i+1, totalParcelas: parcelas, groupId
      };
      transactions.unshift(tx);
    }
    showToast('‚úÖ ' + parcelas + 'x de ' + fmt(valorParcela) + ' adicionadas!');
  } else {
    const tx = { id: Date.now(), date, value, category, desc: desc||category, payment, kind, obs, type: currentType };
    transactions.unshift(tx);
    showToast('‚úÖ Lan√ßamento adicionado!');
  }

  save();
  document.getElementById('tx-value').value = '';
  document.getElementById('tx-desc').value = '';
  document.getElementById('tx-obs').value = '';
  document.getElementById('tx-parcelas').value = '1';
  document.getElementById('parcelas-group').style.display = 'none';
  document.getElementById('tx-payment').value = 'pix';
  buildMonthFilters();
  renderTxList();
  updateDashboard();
  checkAlerts();
}
function deleteTransaction(id, groupId, totalParcelas) {
  if(groupId && totalParcelas > 1) {
    const choice = confirm('Esse lan√ßamento √© parcelado (' + totalParcelas + 'x).\n\nOK = apagar TODAS as parcelas\nCancelar = apagar s√≥ esta parcela');
    if(choice) {
      transactions = transactions.filter(t => t.groupId !== groupId);
      showToast('üóëÔ∏è Todas as parcelas removidas', 'error');
    } else {
      transactions = transactions.filter(t => t.id !== id);
      showToast('üóëÔ∏è Parcela removida', 'error');
    }
  } else {
    transactions = transactions.filter(t => t.id !== id);
    showToast('üóëÔ∏è Lan√ßamento removido', 'error');
  }
  save();
  renderTxList();
  updateDashboard();
}
function save() {
  localStorage.setItem('transactions', JSON.stringify(transactions));
  localStorage.setItem('goals', JSON.stringify(goals));
  localStorage.setItem('catLimits', JSON.stringify(catLimits));
}
function getMonthTx(month) {
  return transactions.filter(t => t.date.startsWith(month));
}
function getFilteredTx() {
  return transactions.filter(t => {
    if(filterMonth && !t.date.startsWith(filterMonth)) return false;
    if(filterType !== 'todos' && t.type !== filterType) return false;
    if(filterPayment !== 'todos' && t.payment !== filterPayment) return false;
    if(filterGroupId && Number(t.groupId) !== Number(filterGroupId)) return false;
    return true;
  });
}
function renderTxList() {
  const list = document.getElementById('tx-list');
  const txs = getFilteredTx();
  if(!txs.length) { list.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>Nenhum lan√ßamento encontrado</p></div>'; return; }
  list.innerHTML = txs.map(t => `
    <div class="tx-item">
      <div class="tx-icon ${t.type}">${CAT_ICONS[t.category]||'üíº'}</div>
      <div class="tx-info">
        <div class="tx-desc">${t.desc}</div>
        <div class="tx-meta">${new Date(t.date+'T12:00').toLocaleDateString('pt-BR')} ¬∑ ${t.category} ¬∑ <span class="badge ${t.kind}">${t.kind}</span> ¬∑ <span style="font-size:11px;color:var(--text2)">${{pix:'üí∏ Pix',debito:'üí≥ D√©bito',credito:'üí≥ Cr√©dito',dinheiro:'üíµ Dinheiro'}[t.payment]||t.payment}</span></div>
        ${t.parcelado ? `<div class="tx-meta"><span class="badge fixo" style="cursor:pointer" onclick="buildGroupFilter(${t.groupId}, '${t.desc.replace(/\s*\(\d+\/\d+\)/,'')}', ${t.totalParcelas})">üí≥ ver todas as ${t.totalParcelas} parcelas</span></div>` : ''}
        ${t.obs ? `<div class="tx-meta" style="color:var(--text2);font-style:italic">${t.obs}</div>` : ''}
      </div>
      <div>
        <div class="tx-amount ${t.type==='entrada'?'green':'red'}">${t.type==='entrada'?'+':'-'}${fmt(t.value)}</div>
      </div>
      <button class="tx-delete" onclick="deleteTransaction(${t.id}, ${t.groupId||'null'}, ${t.totalParcelas||1})">üóëÔ∏è</button>
    </div>
  `).join('');
}

function updateDashboard() {
  const txs = getMonthTx(currentMonth);
  const income = txs.filter(t=>t.type==='entrada').reduce((s,t)=>s+t.value,0);
  const expense = txs.filter(t=>t.type==='saida').reduce((s,t)=>s+t.value,0);
  const balance = income - expense;
  const [y, m] = currentMonth.split('-');
  const monthLabel = new Date(y,m-1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const balanceEl = document.getElementById('balance-value');
  balanceEl.textContent = (balance < 0 ? '-' : '') + fmt(balance);
  balanceEl.style.color = balance < 0 ? '#ff4d6d' : '#003322';
  document.getElementById('balance-month').textContent = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);
  document.getElementById('total-income').textContent = fmt(income);
  document.getElementById('total-expense').textContent = fmt(expense);
  checkAlerts();
  renderPieChart(txs);
  renderBarChart();
  renderPaymentChart(txs);
}
function checkAlerts() {
  const txs = getMonthTx(currentMonth);
  const container = document.getElementById('alerts-container');
  const alerts = [];
  Object.entries(catLimits).forEach(([cat, limit]) => {
    const spent = txs.filter(t=>t.type==='saida' && t.category===cat).reduce((s,t)=>s+t.value,0);
    const pct = spent/limit;
    if(pct >= 1) alerts.push(`üö® <b>${cat}</b>: limite excedido! (${fmt(spent)} / ${fmt(limit)})`);
    else if(pct >= 0.8) alerts.push(`‚ö†Ô∏è <b>${cat}</b>: 80% do limite atingido (${fmt(spent)} / ${fmt(limit)})`);
  });
  if(goals.savings) {
    const income = txs.filter(t=>t.type==='entrada').reduce((s,t)=>s+t.value,0);
    const expense = txs.filter(t=>t.type==='saida').reduce((s,t)=>s+t.value,0);
    const saved = income - expense;
    if(saved < 0) alerts.push(`üí° <b>Dica:</b> Voc√™ est√° gastando mais do que ganha este m√™s.`);
  }
  container.innerHTML = alerts.map(a => `<div class="alert-card">üì¢ <span>${a}</span></div>`).join('');
}
function renderPieChart(txs) {
  const catTotals = {};
  txs.filter(t=>t.type==='saida').forEach(t => { catTotals[t.category] = (catTotals[t.category]||0) + t.value; });
  const labels = Object.keys(catTotals);
  const data = Object.values(catTotals);
  const colors = ['#00e5a0','#ff4d6d','#ffd166','#4d9fff','#a855f7','#ff9f43','#54a0ff','#5f27cd','#48dbfb','#ff6b81'];
  const ctx = document.getElementById('pie-chart').getContext('2d');
  if(charts.pie) charts.pie.destroy();
  if(!labels.length) { ctx.clearRect(0,0,300,200); return; }
  charts.pie = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 8 }] },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text') || '#fff', font:{size:11}, padding:10, boxWidth:10 } } }
    }
  });
}
function renderBarChart() {
  const months = [];
  for(let i=5;i>=0;i--) {
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    months.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
  }
  const labels = months.map(m => { const [y,mo] = m.split('-'); return new Date(y,mo-1).toLocaleDateString('pt-BR',{month:'short'}); });
  const incomes = months.map(m => transactions.filter(t=>t.date.startsWith(m)&&t.type==='entrada').reduce((s,t)=>s+t.value,0));
  const expenses = months.map(m => transactions.filter(t=>t.date.startsWith(m)&&t.type==='saida').reduce((s,t)=>s+t.value,0));
  const ctx = document.getElementById('bar-chart').getContext('2d');
  if(charts.bar) charts.bar.destroy();
  charts.bar = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label:'Entradas', data:incomes, backgroundColor:'rgba(0,229,160,0.8)', borderRadius:8 },
      { label:'Sa√≠das', data:expenses, backgroundColor:'rgba(255,77,109,0.8)', borderRadius:8 }
    ]},
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: { legend: { labels: { color:'#888', font:{size:11} } } },
      scales: {
        x: { grid:{display:false}, ticks:{color:'#888'} },
        y: { grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#888', callback:v=>'R$'+v} }
      }
    }
  });
}

function renderPaymentChart(txs) {
  const paymentTotals = {};
  const labels_map = {pix:'üí∏ Pix', debito:'üí≥ D√©bito', credito:'üí≥ Cr√©dito', dinheiro:'üíµ Dinheiro'};
  txs.filter(t=>t.type==='saida').forEach(t => {
    const label = labels_map[t.payment] || t.payment;
    paymentTotals[label] = (paymentTotals[label]||0) + t.value;
  });
  const labels = Object.keys(paymentTotals);
  const data = Object.values(paymentTotals);
  const colors = ['#4d9fff','#ff4d6d','#a855f7','#ffd166'];
  const ctx = document.getElementById('payment-chart').getContext('2d');
  if(charts.payment) charts.payment.destroy();
  if(!labels.length) { ctx.clearRect(0,0,300,200); return; }
  charts.payment = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 8 }] },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '60%',
      plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#fff', font:{size:11}, padding:10, boxWidth:10 } } }
    }
  });
}

// METAS
function setSavingsGoal() {
  const val = parseFloat(document.getElementById('savings-goal-input').value);
  if(!val||val<=0) { showToast('‚ö†Ô∏è Insira um valor v√°lido', 'error'); return; }
  goals.savings = val;
  save();
  renderMetas();
  showToast('üéØ Meta salva!');
}
function setCategoryLimit() {
  const cat = document.getElementById('cat-limit-select').value;
  const val = parseFloat(document.getElementById('cat-limit-input').value);
  if(!val||val<=0) { showToast('‚ö†Ô∏è Insira um valor v√°lido', 'error'); return; }
  catLimits[cat] = val;
  save();
  renderMetas();
  showToast(`‚úÖ Limite de ${cat} salvo!`);
}
function renderMetas() {
  const txs = getMonthTx(currentMonth);
  const income = txs.filter(t=>t.type==='entrada').reduce((s,t)=>s+t.value,0);
  const expense = txs.filter(t=>t.type==='saida').reduce((s,t)=>s+t.value,0);
  const saved = Math.max(0, income - expense);

  // savings progress
  const sp = document.getElementById('savings-progress');
  if(goals.savings) {
    const pct = Math.min(100, (saved/goals.savings)*100);
    const color = pct>=100?'green':pct>=60?'yellow':'red';
    document.getElementById('savings-goal-input').value = goals.savings;
    sp.innerHTML = `
      <div class="progress-wrap">
        <div class="progress-header"><span>Guardado: ${fmt(saved)}</span><span>Meta: ${fmt(goals.savings)}</span></div>
        <div class="progress-track"><div class="progress-bar ${color}" style="width:${pct}%"></div></div>
        <div style="font-size:12px;color:var(--text2);margin-top:6px">
          ${pct>=100 ? 'üéâ Meta atingida!' : `Faltam ${fmt(goals.savings - saved)} para a meta`}
        </div>
      </div>`;
  } else { sp.innerHTML = ''; }

  // cat limits select
  const sel = document.getElementById('cat-limit-select');
  sel.innerHTML = CATEGORIES.saida.map(c => `<option value="${c}">${CAT_ICONS[c]||'üíº'} ${c}</option>`).join('');

  // cat limits list
  const container = document.getElementById('category-limits');
  if(!Object.keys(catLimits).length) { container.innerHTML = '<p style="color:var(--text2);font-size:13px;text-align:center;padding:10px">Nenhum limite definido ainda</p>'; return; }
  container.innerHTML = Object.entries(catLimits).map(([cat, limit]) => {
    const spent = txs.filter(t=>t.type==='saida'&&t.category===cat).reduce((s,t)=>s+t.value,0);
    const pct = Math.min(100,(spent/limit)*100);
    const color = pct>=100?'red':pct>=80?'yellow':'green';
    return `<div class="progress-wrap">
      <div class="progress-header"><span>${CAT_ICONS[cat]||'üíº'} ${cat}</span><span>${fmt(spent)} / ${fmt(limit)}</span></div>
      <div class="progress-track"><div class="progress-bar ${color}" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

// RELAT√ìRIOS
function generateReport() {
  renderRelatorios();
}
function renderRelatorios() {
  const from = document.getElementById('report-from').value || getMonthsAgo(5);
  const to = document.getElementById('report-to').value || currentMonth;
  const allMonths = getMonthsRange(from, to);
  const filtered = transactions.filter(t => t.date.substring(0,7) >= from && t.date.substring(0,7) <= to);

  // line chart (saldo acumulado)
  const labels = allMonths.map(m => { const [y,mo] = m.split('-'); return new Date(y,mo-1).toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}); });
  let running = 0;
  const balances = allMonths.map(m => {
    const inc = transactions.filter(t=>t.date.startsWith(m)&&t.type==='entrada').reduce((s,t)=>s+t.value,0);
    const exp = transactions.filter(t=>t.date.startsWith(m)&&t.type==='saida').reduce((s,t)=>s+t.value,0);
    running += inc - exp;
    return running;
  });
  const ctx1 = document.getElementById('line-chart').getContext('2d');
  if(charts.line) charts.line.destroy();
  charts.line = new Chart(ctx1, {
    type:'line',
    data:{ labels, datasets:[{ label:'Saldo', data:balances, borderColor:'#00e5a0', backgroundColor:'rgba(0,229,160,0.1)', fill:true, tension:0.4, pointBackgroundColor:'#00e5a0', pointRadius:5 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#888'}}}, scales:{ x:{grid:{display:false},ticks:{color:'#888'}}, y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#888',callback:v=>'R$'+v}} } }
  });

  // compare chart
  const incomes2 = allMonths.map(m => transactions.filter(t=>t.date.startsWith(m)&&t.type==='entrada').reduce((s,t)=>s+t.value,0));
  const expenses2 = allMonths.map(m => transactions.filter(t=>t.date.startsWith(m)&&t.type==='saida').reduce((s,t)=>s+t.value,0));
  const ctx2 = document.getElementById('compare-chart').getContext('2d');
  if(charts.compare) charts.compare.destroy();
  charts.compare = new Chart(ctx2, {
    type:'bar',
    data:{ labels, datasets:[
      { label:'Entradas', data:incomes2, backgroundColor:'rgba(0,229,160,0.8)', borderRadius:6 },
      { label:'Sa√≠das', data:expenses2, backgroundColor:'rgba(255,77,109,0.8)', borderRadius:6 }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#888',font:{size:11}}}}, scales:{ x:{grid:{display:false},ticks:{color:'#888'}}, y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#888'}} } }
  });

  // ranking
  const catTotals = {};
  filtered.filter(t=>t.type==='saida').forEach(t => { catTotals[t.category]=(catTotals[t.category]||0)+t.value; });
  const sorted = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);
  const ranking = document.getElementById('ranking-list');
  ranking.innerHTML = sorted.length ? sorted.map(([cat,val],i) => `
    <div class="rank-item">
      <div class="rank-num">${i+1}</div>
      <div class="tx-icon saida" style="width:36px;height:36px;font-size:16px">${CAT_ICONS[cat]||'üíº'}</div>
      <div class="rank-info"><div class="rank-cat">${cat}</div></div>
      <div class="rank-amount">${fmt(val)}</div>
    </div>`).join('') : '<div class="empty-state"><div class="icon">üìä</div><p>Sem dados no per√≠odo</p></div>';

  // avg
  const months = allMonths.length || 1;
  const avgList = document.getElementById('avg-list');
  avgList.innerHTML = sorted.length ? sorted.map(([cat,val]) => `
    <div class="progress-wrap">
      <div class="progress-header" style="font-size:13px"><span>${CAT_ICONS[cat]||'üíº'} ${cat}</span><span style="color:var(--red)">${fmt(val/months)}/m√™s</span></div>
    </div>`).join('') : '<div class="empty-state"><div class="icon">üìä</div><p>Sem dados no per√≠odo</p></div>';
}

function getMonthsAgo(n) {
  const d = new Date(now.getFullYear(), now.getMonth()-n, 1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
function getMonthsRange(from, to) {
  const months = [];
  let cur = new Date(from+'-01');
  const end = new Date(to+'-01');
  while(cur <= end) {
    months.push(`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`);
    cur.setMonth(cur.getMonth()+1);
  }
  return months;
}

// INIT
function init() {
  document.getElementById('tx-date').value = new Date().toISOString().split('T')[0];
  const [y,m] = currentMonth.split('-');
  document.getElementById('report-from').value = getMonthsAgo(5);
  document.getElementById('report-to').value = currentMonth;
  document.getElementById('savings-goal-input').value = goals.savings || '';
  updateCategoryOptions();
  buildMonthFilters();
  updateDashboard();
}
init();
</script>
</body>
</html>
